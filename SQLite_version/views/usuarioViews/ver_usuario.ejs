<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Usuários</h2>
        <p class="text-muted mb-0">Lista de usuários do sistema</p>
    </div>
    <button class="btn btn-outline-primary" onclick="carregarUsuarios()">Atualizar</button>
</div>

<div id="message" class="alert" style="display:none;"></div>

<div class="card">
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Nível</th>
                    <th>Cadastrado em</th>
                    <th>Opções</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr id="loadingRow">
                    <td colspan="6" class="text-center py-3">Carregando...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    async function carregarUsuarios() {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch('/api/usuarios/list', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const result = await response.json();
            const messageDiv = document.getElementById('message');

            if (result.error) {
                emitirMensagem(messageDiv, 'danger', result.error || 'Erro ao listar usuários.');
            } else {
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                if (result.length <= 0) {
                    emitirMensagem(messageDiv, 'warning', 'Não existem usuários cadastrados.');
                } else {
                    const nivelUsuario = getNivelUsuario();
                    
                    for (let i = 0; i < result.length; i++) {
                        const element = result[i];
                        const dataCadastro = new Date(element.createdAt).toLocaleDateString('pt-PT');
                        tableBody.innerHTML += `<tr id="colum${i}"></tr>`;
                        const atualColm = document.getElementById(`colum${i}`);
                        
                        atualColm.innerHTML += `<td><span class="badge bg-primary">${element.id}</span></td>`;
                        atualColm.innerHTML += `<td><strong>${element.username}</strong></td>`;
                        atualColm.innerHTML += `<td>${element.email || 'N/A'}</td>`;
                        atualColm.innerHTML += `<td><span class="badge bg-${element.nivel === 'admin' ? 'danger' : 'secondary'}">${element.nivel}</span></td>`;
                        atualColm.innerHTML += `<td class="text-muted">${dataCadastro}</td>`;
                        
                        // Admin pode editar/deletar todos
                        // Gerente só pode editar/deletar aluno e motorista
                        const podeEditar = podeEditarUsuario(nivelUsuario, element.nivel);
                        
                        if (podeEditar) {
                            atualColm.innerHTML += `
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editarUsuario(${element.id})" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="confirmarDelete(${element.id}, 'usuario')" title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>`;
                        } else {
                            atualColm.innerHTML += `<td>-</td>`;
                        }
                    }
                }
            }
        } catch (err) {
            console.error('Erro:', err);
            const messageDiv = document.getElementById('message');
            emitirMensagem(messageDiv, 'danger', 'Erro na conexão.');
        }
    }

    // Função para obter nível do usuário
    function getNivelUsuario() {
        const token = localStorage.getItem('token');
        if (!token) return null;
        
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.nivel;
        } catch (e) {
            return null;
        }
    }

    // Função para verificar se pode editar/deletar um usuário específico
    function podeEditarUsuario(nivelUsuario, nivelAlvo) {
        if (nivelUsuario === 'admin') {
            return true; // Admin pode tudo
        }
        
        if (nivelUsuario === 'gerente') {
            // Gerente só pode editar aluno e motorista
            return nivelAlvo === 'aluno' || nivelAlvo === 'motorista';
        }
        
        return false;
    }

    document.addEventListener('DOMContentLoaded', carregarUsuarios());
</script>
