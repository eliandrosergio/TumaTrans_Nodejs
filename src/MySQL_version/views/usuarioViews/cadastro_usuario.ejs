<div class="mb-4">
    <h2>Cadastrar Usuário</h2>
    <p class="text-muted">Adicionar novo usuário ao sistema</p>
</div>

<div class="card">
    <div class="card-body">
        <div id="message" class="alert" style="display:none;"></div>
        
        <form id="usuarioForm">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="username" class="form-label">Nome de Usuário</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                    <small class="text-muted">Mínimo 3 caracteres</small>
                </div>

                <div class="col-md-6">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email">
                </div>

                <div class="col-md-6">
                    <label for="password" class="form-label">Senha</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="password" name="password" required>
                        <button type="button" id="togglePassword" class="btn btn-outline-secondary">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <small class="text-muted">Mínimo 8 caracteres</small>
                </div>

                <div class="col-md-6">
                    <label for="password2" class="form-label">Confirmar Senha</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="password2" name="password2" required>
                        <button type="button" id="togglePassword2" class="btn btn-outline-secondary">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="col-md-6">
                    <label for="nivel" class="form-label">Nível de Acesso</label>
                    <select class="form-control" id="nivel" name="nivel" required>
                        <option value="">Selecione...</option>
                        <option value="admin">Administrador</option>
                        <option value="gerente">Gerente</option>
                        <option value="aluno">Aluno</option>
                        <option value="motorista">Motorista</option>
                    </select>
                </div>

                <div class="col-md-6" id="vinculoContainer" style="display:none;">
                    <label for="vinculo_id" class="form-label">Vínculo</label>
                    <select class="form-control" id="vinculo_id" name="vinculo_id">
                        <option value="">Selecione...</option>
                    </select>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Cadastrar</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Toggle senha
    document.getElementById('togglePassword').addEventListener('click', () => {
        const passwordInput = document.getElementById('password');
        const toggleBtn = document.getElementById('togglePassword');
        const icon = toggleBtn.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            passwordInput.type = 'password';
            icon.className = 'bi bi-eye';
        }
    });

    document.getElementById('togglePassword2').addEventListener('click', () => {
        const passwordInput = document.getElementById('password2');
        const toggleBtn = document.getElementById('togglePassword2');
        const icon = toggleBtn.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            passwordInput.type = 'password';
            icon.className = 'bi bi-eye';
        }
    });

    // Mostrar campo de vínculo apenas para aluno e motorista
    document.getElementById('nivel').addEventListener('change', async function() {
        const nivel = this.value;
        const vinculoContainer = document.getElementById('vinculoContainer');
        const vinculoSelect = document.getElementById('vinculo_id');
        
        if (nivel === 'aluno' || nivel === 'motorista') {
            vinculoContainer.style.display = 'block';
            vinculoSelect.required = true;
            
            const token = localStorage.getItem('token');
            const endpoint = nivel === 'aluno' ? '/api/alunos/list' : '/api/motoristas/list';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const dados = await response.json();
                
                vinculoSelect.innerHTML = '<option value="">Selecione...</option>';
                dados.forEach(item => {
                    vinculoSelect.innerHTML += `<option value="${item.id}">${item.nome}</option>`;
                });
            } catch (err) {
                console.error('Erro ao carregar vínculos:', err);
            }
        } else {
            vinculoContainer.style.display = 'none';
            vinculoSelect.required = false;
            vinculoSelect.value = '';
        }
    });

    document.getElementById('usuarioForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const password = document.getElementById('password').value;
        const password2 = document.getElementById('password2').value;
        const messageDiv = document.getElementById('message');

        // Verificar se as senhas coincidem
        if (password !== password2) {
            emitirMensagem(messageDiv, 'danger', 'As senhas não coincidem.');
            return;
        }

        const token = localStorage.getItem('token');
        const data = {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            password: password,
            nivel: document.getElementById('nivel').value,
            vinculo_id: document.getElementById('vinculo_id').value || null
        };
        
        try {
            const response = await fetch('/api/usuarios/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok) {
                emitirMensagem(messageDiv, 'success', result.message);
                document.getElementById('usuarioForm').reset();
            } else {
                emitirMensagem(messageDiv, 'danger', result.error || 'Erro ao cadastrar.');
            }
        } catch (err) {
            console.error('Erro:', err);
            emitirMensagem(messageDiv, 'danger', 'Erro na conexão.');
        }
    });
</script>
