<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Alunos</h2>
        <p class="text-muted mb-0">Lista de estudantes cadastrados</p>
    </div>
    <button class="btn btn-outline-primary" onclick="carregarAlunos()">Atualizar</button>
</div>

<div id="message" class="alert" style="display:none;"></div>

<div class="card">
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
				<tr>
					<th>ID</th>
					<th>Nome</th>
					<th>Data Nasc.</th>
					<th>Processo</th>
					<th>Endereço</th>
					<th>Tel. Aluno</th>
					<th>Tel. Responsável</th>
					<th>Opções</th>
				</tr>
			</thead>
            <tbody id="tableBody">
                <tr id="loadingRow">
                    <td colspan="7" class="text-center py-3">Carregando...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
	// Carrega a lista de alunos
	async function carregarAlunos() {
		const token = localStorage.getItem('token');
		try {
			const response = await fetch('/api/alunos/list', {
				method: 'POST',
				headers: {
					'Authorization': `Bearer ${token}`
				}
			});
			const result = await response.json();
			const messageDiv = document.getElementById('message');

			if (result.error) {
				emitirMensagem(messageDiv, 'danger', result.error || 'Erro ao listar alunos.');
			} else {
				const tableBody = document.getElementById('tableBody');
				tableBody.innerHTML = '';
				if (result.length <= 0) {
					emitirMensagem(messageDiv, 'warning', 'Não existe alunos cadastrados.');
				} else {
					const podeEditar = podeEditarDeletar(); // Verifica permissão
					
					for (let i = 0; i < result.length; i++) {
						const element = result[i];
						tableBody.innerHTML += `<tr id="colum${i}"></tr>`;
						const atualColm = document.getElementById(`colum${i}`);
						
						atualColm.innerHTML += `<td><span class="badge bg-primary">${element.id}</span></td>`;
						atualColm.innerHTML += `<td><strong>${element.nome}</strong></td>`;
						atualColm.innerHTML += `<td class="text-muted">${element.data_nascimento}</td>`;
						atualColm.innerHTML += `<td><span class="badge bg-secondary">${element.num_processo}</span></td>`;
						atualColm.innerHTML += `<td class="text-muted">${element.endereco}</td>`;
						atualColm.innerHTML += `<td>${element.telefone_aluno || 'N/A'}</td>`;
						atualColm.innerHTML += `<td>${element.telefone_encarregado}</td>`;
						
						// Só mostra botões se tiver permissão
						if (podeEditar) {
							atualColm.innerHTML += `
								<td>
									<button class="btn btn-sm btn-outline-primary me-1" onclick="editarAluno(${element.id})" title="Editar">
										<i class="bi bi-pencil"></i>
									</button>
									<button class="btn btn-sm btn-outline-danger" onclick="confirmarDelete(${element.id}, 'aluno')" title="Excluir">
										<i class="bi bi-trash"></i>
									</button>
								</td>`;
						} else {
							atualColm.innerHTML += `<td>-</td>`;
						}
					}
				}
			}
		} catch (err) {
			console.error('Erro:', err);
			const messageDiv = document.getElementById('message');
			emitirMensagem(messageDiv, 'danger', 'Erro na conexão.');
		}
	}

	// Função para verificar se pode editar/deletar
	function podeEditarDeletar() {
		const token = localStorage.getItem('token');
		if (!token) return false;
		
		try {
			const payload = JSON.parse(atob(token.split('.')[1]));
			return payload.nivel === 'admin' || payload.nivel === 'gerente';
		} catch (e) {
			return false;
		}
	}

	document.addEventListener('DOMContentLoaded', carregarAlunos());
</script>
