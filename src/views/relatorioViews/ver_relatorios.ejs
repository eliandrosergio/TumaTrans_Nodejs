<div class="mb-4">
    <h2>Relatórios</h2>
    <p class="text-muted">Visualize dados e estatísticas do sistema</p>
</div>

<div class="row g-3" id="relatoriosContainer">
    <!-- Conteúdo carregado dinamicamente -->
</div>

<script>
    function getNivelUsuario() {
        const token = localStorage.getItem('token');
        if (!token) return null;
        
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.nivel;
        } catch (e) {
            return null;
        }
    }

    // Carregar próximos horários
    async function carregarProximosHorarios() {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch('/api/relatorios/proximos-horarios', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const horarios = await response.json();
            
            const container = document.getElementById('proximosHorariosConteudo');
            if (!container) return;
            
            if (horarios.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma rota programada</p>';
                return;
            }
            
            let html = '';
            horarios.forEach(rota => {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${rota.nome}</strong><br>
                            <small>${rota.motorista?.nome || 'N/A'}</small>
                        </div>
                        <span class="badge bg-primary">${rota.horario_inicio}</span>
                    </div>
                `;
            });
            container.innerHTML = html;
        } catch (err) {
            console.error('Erro:', err);
        }
    }
    
    // Carregar estatísticas
    async function carregarEstatisticas() {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch('/api/relatorios/dashboard', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const stats = await response.json();
            
            const statAlunos = document.getElementById('statAlunos');
            const statRotas = document.getElementById('statRotas');
            
            if (statAlunos) statAlunos.textContent = stats.totalAlunos;
            if (statRotas) statRotas.textContent = stats.totalRotas;
        } catch (err) {
            console.error('Erro:', err);
        }
    }

    // Montar interface baseada no nível do usuário
    function montarRelatorios() {
        const nivel = getNivelUsuario();
        const container = document.getElementById('relatoriosContainer');
        
        if (!nivel) {
            window.location.href = '/login';
            return;
        }
        
        let html = '';
        
        // Para ALUNOS e MOTORISTAS - apenas Próximos Horários
        if (nivel === 'aluno' || nivel === 'motorista') {
            html = `
                <div class="col-12">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Próximos Horários</h5>
                            <p class="card-text text-muted">Veja as próximas rotas ${nivel === 'aluno' ? 'da sua rota' : 'das suas rotas'}</p>
                            <div id="proximosHorariosConteudo">
                                <p class="text-muted">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Para ADMIN e GERENTE - todos os relatórios
        if (nivel === 'admin' || nivel === 'gerente') {
            html = `
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Alunos por Rota</h5>
                            <p class="card-text text-muted">Visualize quantos alunos estão em cada rota</p>
                            <a href="#" onclick="navigateWithToken(event, '/api/relatorios/alunos-rota')" class="btn btn-primary">
                                Ver Relatório
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Relatório de Viagens</h5>
                            <p class="card-text text-muted">Acompanhamento de horários e presenças nas viagens</p>
                            <a href="#" onclick="navigateWithToken(event, '/api/relatorios/viagens')" class="btn btn-primary">
                                Ver Relatório
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Próximos Horários</h5>
                            <p class="card-text text-muted">Veja as próximas rotas do dia</p>
                            <div id="proximosHorariosConteudo">
                                <p class="text-muted">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Estatísticas Gerais</h5>
                            <p class="card-text text-muted">Números totais do sistema</p>
                            <div id="estatisticas">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h4 id="statAlunos" class="text-primary">-</h4>
                                        <small>Alunos</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 id="statRotas" class="text-info">-</h4>
                                        <small>Rotas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
        
        // Após montar, carregar os dados
        setTimeout(() => {
            carregarProximosHorarios();
            if (nivel === 'admin' || nivel === 'gerente') {
                carregarEstatisticas();
            }
        }, 100);
    }
    
    document.addEventListener('DOMContentLoaded', montarRelatorios);
</script>
