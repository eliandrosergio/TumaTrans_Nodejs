<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Rotas</h2>
        <p class="text-muted mb-0">Lista de rotas cadastradas</p>
    </div>
    <button class="btn btn-outline-primary" onclick="carregarRotas()">Atualizar</button>
</div>

<div id="message" class="alert" style="display:none;"></div>

<div class="card">
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Descrição</th>
                    <th>Início</th>
                    <th>Fim</th>
                    <th>Motorista</th>
                    <th>Veículo</th>
                    <th>Pontos de Parada</th>
                    <th>Opções</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr id="loadingRow">
                    <td colspan="9" class="text-center py-3">Carregando...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Função para carregar as rotas da API e popular a tabela
    async function carregarRotas() {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch('/api/rotas/list', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            const result = await response.json();
            const messageDiv = document.getElementById('message');
            const tableBody = document.getElementById('tableBody');

            if (!response.ok) {
                emitirMensagem(messageDiv, 'danger', result.error || 'Erro ao listar rotas.');
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center">Erro ao carregar rotas.</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            if (result.length === 0) {
                emitirMensagem(messageDiv, 'warning', 'Não existem rotas cadastradas.');
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center">Nenhuma rota encontrada.</td></tr>';
            } else {
                result.forEach((element, i) => {
                    tableBody.innerHTML += `<tr id="colum${i}"></tr>`;
                    const atualColm = document.getElementById(`colum${i}`);
                    
                    atualColm.innerHTML += `<td><span class="badge bg-primary">${element.id}</span></td>`;
                    atualColm.innerHTML += `<td><strong>${element.nome}</strong></td>`;
                    atualColm.innerHTML += `<td class="text-muted">${element.descricao}</td>`;
                    atualColm.innerHTML += `<td>${element.horario_inicio}</td>`;
                    atualColm.innerHTML += `<td>${element.horario_fim}</td>`;
                    atualColm.innerHTML += `<td><a href="#" onclick="navigateWithToken(event, '/api/motoristas/ver')" class="table-link text-primary">${element.motorista?.id + ". " + element.motorista?.nome || 'N/A'}</a></td>`;
                    atualColm.innerHTML += `<td><a href="#" onclick="navigateWithToken(event, '/api/veiculos/ver')" class="table-link text-primary">${element.veiculo?.id + ". " + element.veiculo?.modelo || 'N/A'}</a></td>`;
                    atualColm.innerHTML += `<td class="text-muted">${element.pontos_parada}</td>`;
                    atualColm.innerHTML += `
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editarRota(${element.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmarDelete(${element.id}, 'rota')" title="Excluir">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>`;
                });
            }
        } catch (err) {
            console.error('Erro:', err);
            const messageDiv = document.getElementById('message');
            emitirMensagem(messageDiv, 'danger', 'Erro na conexão.');
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="9" class="text-center">Erro ao carregar rotas.</td></tr>';
        }
    }

    // Corrigir chamada inicial
    document.addEventListener('DOMContentLoaded', () => carregarRotas());
</script>
